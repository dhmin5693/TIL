# 분산 시스템의 골칫거리

> 어떤 것이든지 잘못될 가능성이 있다면 잘못된다.

위 멘션은 시스템 운영자에게는 가장 합리적인 가정이다.

엔지니어는 모든 상황이 잘못되어 있더라도 제 역할을 해내는 시스템을 구축해야 한다.

## 결함과 부분 장애

- 일반적으로 컴퓨터 내부 결함이 발생하면 잘못된 결과를 반환하기보단 아예 동작하지 않기를 바란다.
    - 잘못된 결과는 다루기 어렵고 혼란스럽다.
- 한 컴퓨터에서 프로그램을 작성할 땐 보통 예측 가능한 방식으로 동작한다.
    - 되거나, 안 되거나 둘 중 하나
- 네트워크로 연결된 분산 시스템 환경에서는 예측 불가능한 오류가 발생한다.
    - 부분 장애(partial failure) 발생 시 원인이 비결정적이라서 고치기 어렵다.

### 클라우드 컴퓨팅과 슈퍼 컴퓨팅

- 대규모 컴퓨팅 시스템 구축 방법
    - 고성능 컴퓨팅: 기상 예보 등에 사용되는 슈퍼컴퓨터
    - 클라우드 컴퓨팅: 네트워크 상에서 연결된 컴퓨터
- 분산 시스템이 동작하게 만드려면 부분 장애 가능성를 고려하여 SW에 내결함성 메커니즘을 넣어야 한다.

## 신뢰성 없는 네트워크

- 내부 네트워크(이더넷)은 대부분 **비동기 패킷 네트워크**
    - 노드는 다른 노드로 메시지를 보낼 수 있으나 네트워크는 도착 여부를 보장하지 않는다.
- 잘못되는 케이스들
    1. 요청 손실
    2. 요청이 큐에서 장기간 대기 (네트워크 과부하 등 원인으로 인해)
    3. 원격 노드 장애 (전원이 꺼지는 물리적 장애 등)
    4. 원격 노드가 일시적으로 응답을 멈췄으나 나중에는 다시 응답 시작할 수 있음 (가비지 컬렉션 휴지가 길다던가)
    5. 원격 노드가 요청을 처리했지만 응답이 네트워크에서 손실 (네트워크 스위치 설정 오류 등)
    6. 원격 노드가 요청을 처리했으나 응답이 지연되다가 나중에 전송 (장비 과부하 등)

이런 문제는 보통 **타임 아웃** 으로 다룬다.

### 현실의 네트워크 결함

- 단일 장비 연결이 끊어지거나, 전체 랙 연결이 끊어지는 경우
- top-of-rack switch, aggregation switch, 로드 밸런서 같은 구성 요소 장애
- 인적 오류 (스위치 설정 오류 등)
- 반드시 네트워크 결함을 견뎌내도록 처리할 필요는 없이 네트워크 오류 시 적당한 오류메시지를 보여주는 것도 타당한 방법
- SW가 문제로부터 복구할 필요는 있다.

### 결함 감지

- 결함있는 노드는 자동으로 감지되어야 한다.
    - 로드 밸런서는 죽은 노드로 요청을 보내면 안된다.
    - 단일 리더 복제를 사용하는 분산 데이터베이스에서 리더에 장애가 발생하면 팔로워 중 하나가 리더로 승격되어야 한다.
- 네트워크에 관한 불확실성으로 노드가 동작 중인지 구별하기 어렵다면 명시적인 피드백을 받는다.
- 요청이 성공했음을 확신하고 싶다면 애플리케이션 자체로부터 긍정 응답을 받아야 한다.
- 요청이 잘못되면 아무 응답도 받지 못할거라고 가정을 하는게 좋다.
